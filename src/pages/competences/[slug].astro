---
import BaseLayout from '@layouts/BaseLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const skills = await getCollection('skills');
  return skills.map(skill => ({
    params: { slug: skill.slug },
    props: { skill },
  }));
}

interface Props {
  skill: CollectionEntry<'skills'>;
}

const { skill } = Astro.props;
const { Content } = await skill.render();

// R√©cup√©rer toutes les comp√©tences pour la navigation
const allSkills = await getCollection('skills');
const sortedSkills = allSkills.sort((a, b) => a.data.order - b.data.order);
const currentIndex = sortedSkills.findIndex(s => s.slug === skill.slug);
const previousSkill = currentIndex > 0 ? sortedSkills[currentIndex - 1] : null;
const nextSkill = currentIndex < sortedSkills.length - 1 ? sortedSkills[currentIndex + 1] : null;

// Niveau en texte
const levelText = skill.data.level === 1 ? 'D√©butant' :
                  skill.data.level === 2 ? 'D√©butant avanc√©' :
                  skill.data.level === 3 ? 'Interm√©diaire' :
                  skill.data.level === 4 ? 'Avanc√©' : 'Expert';

const levelColor = skill.data.level <= 2 ? 'bg-neutral-300' : 
                   skill.data.level === 3 ? 'bg-indigo-400' : 
                   'bg-indigo-600';
---

<BaseLayout 
  title={skill.data.title}
  description={skill.data.description}
>
  <article class="py-20 px-6">
    <div class="max-w-4xl mx-auto">
      <!-- Fil d'Ariane -->
      <nav class="mb-8 text-sm">
        <ol class="flex items-center gap-2 text-neutral-600">
          <li><a href="/" class="hover:text-accent transition-colors">Accueil</a></li>
          <li>/</li>
          <li><a href="/competences" class="hover:text-accent transition-colors">Comp√©tences</a></li>
          <li>/</li>
          <li class="text-neutral-900 font-medium">{skill.data.title}</li>
        </ol>
      </nav>

      <!-- Header -->
      <header class="mb-12">
        <div class="flex items-start gap-6 mb-6">
          <span class="text-6xl md:text-7xl">{skill.data.icon}</span>
          <div class="flex-1">
            <div class="flex items-center gap-3 mb-3">
              <span class={`px-3 py-1 text-sm font-medium rounded-full ${
                skill.data.category === 'technique' 
                  ? 'bg-indigo-100 text-indigo-900' 
                  : 'bg-emerald-100 text-emerald-900'
              }`}>
                {skill.data.category === 'technique' ? 'Technique' : 'Humaine'}
              </span>
            </div>
            <h1 class="text-4xl md:text-5xl font-bold text-neutral-900 mb-4">
              {skill.data.title}
            </h1>
            <p class="text-xl text-neutral-600 mb-4">
              {skill.data.description}
            </p>
            
            <!-- Indicateur de niveau -->
            <div class="flex items-center gap-3">
              <span class="text-sm font-medium text-neutral-700">Niveau de ma√Ætrise :</span>
              <div class="flex gap-1">
                {[...Array(5)].map((_, i) => (
                  <div 
                    class={`w-4 h-4 rounded-full ${i < skill.data.level ? levelColor : 'bg-neutral-200'}`}
                  ></div>
                ))}
              </div>
              <span class="text-sm font-bold text-neutral-900">{levelText} ({skill.data.level}/5)</span>
            </div>
          </div>
        </div>
      </header>

      <!-- Contenu Markdown -->
      <div class="prose prose-neutral max-w-none mb-16">
        <Content />
      </div>
      
      <style>
        .prose :global(h2) {
          font-size: 2rem !important;
          font-weight: 700 !important;
          margin-bottom: 1rem !important;
          margin-top: 3rem !important;
        }
        
        .prose :global(h3) {
          font-size: 1.2rem !important;
          font-weight: 700 !important;
          margin-bottom: 1rem !important;
          margin-top: 2rem !important;
        }
        
        .prose :global(p) {
          margin-bottom: 1.5rem !important;
          line-height: 1.75 !important;
        }
        
        .prose :global(ul) {
          margin-top: 1rem !important;
          margin-bottom: 1.5rem !important;
        }
        
        .prose :global(h2 + h3) {
          margin-top: 1rem !important;
        }
      </style>

      <!-- R√©alisations associ√©es -->
      {skill.data.relatedProjects && skill.data.relatedProjects.length > 0 && (
        <section class="mb-16 p-8 bg-neutral-50 border border-neutral-200 rounded-xl">
          <h2 class="text-2xl font-bold text-neutral-900 mb-6">
            R√©alisations associ√©es
          </h2>
          <div class="grid md:grid-cols-2 gap-4">
            {skill.data.relatedProjects.map((projectSlug) => (
              <a 
                href={`/realisations/${projectSlug}`}
                class="flex items-center gap-3 p-4 bg-white border border-neutral-200 rounded-lg hover:shadow-lg hover:border-accent transition-all group"
              >
                <span class="text-2xl">üìÅ</span>
                <span class="font-medium text-neutral-900 group-hover:text-accent transition-colors">
                  {projectSlug.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                </span>
                <span class="ml-auto text-accent">‚Üí</span>
              </a>
            ))}
          </div>
        </section>
      )}

      <!-- Navigation entre comp√©tences -->
      <nav class="pt-12 border-t border-neutral-200">
        <div class="flex justify-between items-center">
          {previousSkill ? (
            <a 
              href={`/competences/${previousSkill.slug}`}
              class="flex items-center gap-2 px-6 py-3 bg-white border-2 border-neutral-200 rounded-lg hover:border-accent hover:text-accent transition-all group"
            >
              <span class="text-xl">‚Üê</span>
              <div class="text-left">
                <div class="text-xs text-neutral-600 mb-1">Comp√©tence pr√©c√©dente</div>
                <div class="font-medium">{previousSkill.data.title}</div>
              </div>
            </a>
          ) : <div></div>}
          
          <a 
            href="/competences"
            class="px-6 py-3 bg-neutral-100 text-neutral-900 rounded-lg hover:bg-neutral-200 transition-colors font-medium"
          >
            Toutes les comp√©tences
          </a>

          {nextSkill ? (
            <a 
              href={`/competences/${nextSkill.slug}`}
              class="flex items-center gap-2 px-6 py-3 bg-white border-2 border-neutral-200 rounded-lg hover:border-accent hover:text-accent transition-all group"
            >
              <div class="text-right">
                <div class="text-xs text-neutral-600 mb-1">Comp√©tence suivante</div>
                <div class="font-medium">{nextSkill.data.title}</div>
              </div>
              <span class="text-xl">‚Üí</span>
            </a>
          ) : <div></div>}
        </div>
      </nav>
    </div>
  </article>
</BaseLayout>

<style>
  /* Ajout d'une barre accent pour les h2 dans le contenu Markdown */
  .prose h2::before {
    content: '';
    width: 4px;
    height: 2rem;
    background-color: hsl(var(--accent));
    border-radius: 2px;
  }
</style>
